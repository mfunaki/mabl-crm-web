# mabl Test Creation Agent プロンプト作成ガイドライン

mabl の Test Creation Agent にテストを生成させるためのプロンプト（.md）を作成する際のルールとチェックリストです。

本ガイドラインは **mabl-crm-web**（顧客情報管理 CRM Web アプリケーション）向けに作成されています。
手動録画によるテスト仕様は [mabl-tests.md](mabl-tests.md) を参照してください。

---

## 1. テンプレート構造

すべてのプロンプトは以下のセクション構成に従ってください。

```markdown
# {テスト名}

## テスト概要
- **対象URL**: https://mabl-crm-web-ixi7x7b23a-an.a.run.app/{path}
- **テスト名**: {テスト名}
- **目的**: {1文で記述}
- **ラベル**: `ai-generated`, `{カテゴリ}`

## 画面構成
{目視で確認できるUI要素の説明}

## テスト手順
### 1. {セクション名}
1. {ステップ}
2. {ステップ}
...

## 期待される結果
- {箇条書き}

## 注意事項
- {mabl実行時の制約や既知の問題}
```

### セクション名の統一ルール

| セクション | 正しい名称 | 使わない名称 |
|---|---|---|
| 手順 | **テスト手順** | テストステップ |
| 結果 | **期待される結果** | 期待結果 |
| 補足 | **注意事項** | 備考 |

### テスト名の命名規則

```
mabl-crm-web - {機能名}
```

| 例 | 機能 |
|---|---|
| `mabl-crm-web - ログイン` | 認証機能 |
| `mabl-crm-web - 顧客新規登録` | 顧客登録機能 |
| `mabl-crm-web - 顧客検索` | 検索・フィルター機能 |

ファイル名: `{連番2桁}-{機能名(kebab-case)}.md`（例: `01-login.md`）

プロンプトは `docs/prompts/` に保存してください。

---

## 2. ナビゲーション記述のルール

mabl 環境変数 `app.url` はアプリケーションのトップページを指します。
テスト対象のサブページへのアクセス方法を**明確に**記述してください。

### アプリケーションのルート構成

| パス | 画面 |
|---|---|
| `/login` | ログイン画面 |
| `/` | ダッシュボード（ログイン後） |
| `/customers` | 顧客一覧 |
| `/customers/new` | 顧客新規登録 |
| `/customers/{id}` | 顧客詳細・編集 |

### 書き方

```
❌ 悪い例: 「ページにアクセスし」（どのページか不明）
❌ 悪い例: 「対象ページを開く」（ナビゲーション経路が不明）

✅ 良い例: 「https://mabl-crm-web-ixi7x7b23a-an.a.run.app/login に直接アクセスする」
✅ 良い例: 「左サイドバーの「顧客管理」をクリックして /customers ページに遷移する」
```

---

## 3. 要素の指定ルール

Test Creation Agent は生成 AI プロンプトで要素を探すため、**目視で要素を特定できる情報**を主として使用します。
本アプリには `data-testid` 属性が付与されているため、補足情報として併記することを推奨します。

### 使用する情報

| 情報 | 例 |
|---|---|
| **表記テキスト** | 「ログイン」と表示されたボタン |
| **位置関係** | メールアドレス入力欄の下にあるパスワード入力欄 |
| **data-testid（補足）** | ログインボタン（`data-testid="login-button"`） |

### 書き方

```
✅ 良い例: 「ログインボタン（data-testid="login-button"）をクリックする」
✅ 良い例: 「メールアドレス入力欄（data-testid="email-input"）に値を入力する」
❌ 悪い例: 「data-testid="login-button" の要素をクリックする」（目視情報なし）
```

### 主要な data-testid 一覧

[mabl-tests.md の data-testid 一覧](mabl-tests.md#data-testid-一覧) を参照してください。

---

## 4. テスト手順の構成パターン

```
0. 前提条件（必要な場合）
   └─ ログイン済み状態の確認等

1. ページ表示の確認
   └─ 対象ページが正しく表示されることを確認

2. 失敗ケースの確認（バリデーション等）
   └─ 不正な入力に対するエラー処理を先に検証

3. 成功ケースの実行
   └─ 正常な入力でメイン機能を実行

4. 成功結果の確認
   └─ 期待される結果が表示されることを確認

5. 後処理（状態のリセット）
   └─ ログアウト等で初期状態に戻す
```

### 削除操作を含むテストの注意

本アプリの削除操作は `window.confirm` ではなく**カスタム確認モーダル**を使用しています。

```
✅ 正しい手順:
1. 削除ボタン（data-testid="delete-button-{id}"）をクリックする
2. 削除確認ダイアログ（data-testid="delete-confirm-dialog"）が表示されることを確認する
3. ダイアログ内の削除確認メッセージ（data-testid="delete-confirm-message"）に顧客名が含まれることを確認する
4. 削除実行ボタン（data-testid="delete-confirm-ok"）をクリックする
5. ダイアログが閉じることを確認する

❌ 誤った手順:
1. 削除ボタンをクリックする
2. ブラウザの確認ダイアログで OK をクリックする（← このアプリでは使用していない）
```

---

## 5. 認証情報の管理ルール

### 認証情報はハードコードしない

```
❌ 悪い例:
- 「email」欄に「admin@demo.com」を入力する
- 「password」欄に「Mabl@Admin#2024」を入力する

✅ 良い例:
- メールアドレス入力欄（data-testid="email-input"）に
  mabl クレデンシャル「管理者アカウント」の ID を入力する
- パスワード入力欄（data-testid="password-input"）に
  mabl クレデンシャル「管理者アカウント」のパスワードを入力する
```

### 使用するクレデンシャル

| クレデンシャル名 | 権限 | 使用場面 |
|---|---|---|
| 管理者アカウント | ADMIN | 顧客の登録・編集・削除を含むテスト |
| 一般ユーザーアカウント | USER | 参照系のテスト |

---

## 6. 生成 AI アサーションの活用

### 適切な使用場面

```
✅ 適切: 「総顧客数カードに数値が表示されていること」
✅ 適切: 「テーブルに顧客データが表示されていること」
✅ 適切: 「削除確認ダイアログが表示されていないことを確認する」
✅ 適切: 「保存ボタンが無効化されていることを確認する」
```

### 不適切な使用場面

```
❌ 不適切: 「APIレスポンスが正しいことを確認する」（画面に表示されない情報）
```

---

## 7. よくある失敗パターンと回避策

| パターン | 原因 | 対策 |
|---|---|---|
| ログイン画面に遷移できない | `app.url` がトップにリダイレクトする | `/login` への直接 URL アクセスを指定する |
| 削除確認が動作しない | ブラウザネイティブの `confirm` を想定している | カスタムモーダルの操作手順を明記する（セクション 4 参照） |
| 顧客行の要素を特定できない | `{id}` 付き data-testid を想定できない | 「テスト 太郎の行にある編集ボタン」のように顧客名で区別する |
| ステータスフィルターが動作しない | `<select>` 要素の操作が不明確 | 「ステータスフィルター（data-testid="status-filter"）で「取引中」を選択する」と明記する |

---

## 8. プロンプト作成の実行手順

### Step 1: 対象機能の確認

1. [mabl-tests.md](mabl-tests.md) で既存のテストシナリオを確認する
2. テスト対象の画面と操作要素を `src/app/` 配下のソースコードで確認する
3. 使用する `data-testid` を [data-testid 一覧](mabl-tests.md#data-testid-一覧) で確認する

### Step 2: プロンプト作成

1. セクション 1 のテンプレート構造に従う
2. 要素は目視情報を主とし、`data-testid` を補足として併記する
3. テスト手順はセクション 4 の 5 段階構成にする
4. 削除操作を含む場合はセクション 4 の手順に従う
5. 認証情報はセクション 5 のルールに従う

### Step 3: 品質チェック

作成後、セクション 9 のチェックリストで確認する

---

## 9. 品質チェックリスト

- [ ] テンプレート構造（セクション 1）に準拠しているか
- [ ] セクション名が統一ルールに従っているか
- [ ] テスト概要に対象 URL・テスト名・目的・ラベルがすべて含まれているか
- [ ] 対象ページへのアクセス方法が明確か（直接 URL またはナビゲーション経路）
- [ ] 要素の指定に目視情報が使われているか（data-testid は補足として併記）
- [ ] 削除操作はカスタムモーダルの手順で記述されているか
- [ ] 失敗ケース → 成功ケースの順になっているか
- [ ] 後処理（ログアウト等）が含まれているか
- [ ] 認証情報がハードコードされていないか（mabl クレデンシャルを使用しているか）
- [ ] テスト名が命名規則（`mabl-crm-web - {機能名}`）に従っているか
- [ ] ファイル名が `{連番2桁}-{機能名}.md` 形式か
- [ ] `ai-generated` ラベルが含まれているか

---

## 10. ラベル体系

### 作成方法ラベル（必須）

- `ai-generated`: Test Creation Agent で作成したテスト

### 機能カテゴリラベル

| ラベル | 対象機能 |
|---|---|
| `auth` | ログイン・ログアウト・認証保護 |
| `dashboard` | ダッシュボード・統計表示 |
| `customer` | 顧客一覧・登録・編集・削除 |
| `search` | 検索・フィルター |

---

## 更新履歴

| 日付 | 内容 |
|---|---|
| 2026-02-20 | mabl-crm-web 向けに初版作成。手動録画テストの知見（カスタム削除モーダル等）を反映 |
