# mabl テスト仕様

## 対象アプリケーション

顧客情報の登録・管理・検索ができる CRM Web アプリケーション。JWT 認証によるログイン機能と、顧客のステータス管理（アクティブ／非アクティブ／見込み）に対応。

## 環境

| 環境名 | URL |
|---|---|
| dev | http://localhost:3000 |
| staging | （Cloud Run ステージング URL） |
| production | （Cloud Run 本番 URL） |

## クレデンシャル

| クレデンシャル名 | ID | 権限 |
|---|---|---|
| 管理者アカウント | admin@demo.com | ADMIN |
| 一般ユーザーアカウント | user@demo.com | USER |

---

## フロー

### ログイン

クレデンシャルを使って認証し、ダッシュボードへ遷移する共通フロー。シナリオ 3〜8 の前提条件として使用する。

| ステップグループ | 操作 / アサーション |
|---|---|
| `###` 認証情報の入力 | `[data-testid="email-input"]` にクレデンシャルの ID を入力 |
| | `[data-testid="password-input"]` にクレデンシャルのパスワードを入力 |
| `###` ログイン実行と結果確認 | `[data-testid="login-button"]` をクリック |
| | URL が `/` にリダイレクトされること |

---

## テストシナリオ

### シナリオ 1: ログイン - 正常系

**テストラベル:** `ログイン - 正常系`

**概要:** 管理者アカウントで正しい認証情報を入力してログインし、ダッシュボードへ遷移することを確認する。

| エコー | 操作 / アサーション |
|---|---|
| `#` **認証機能** | — |
| `##` **正常ログイン** | — |
| `###` ログインページの表示確認 | URL が `/login` であること |
| | `[data-testid="login-button"]` が表示されていること |
| ▶ フロー: **ログイン**（管理者アカウント） | — |
| `###` ダッシュボード遷移の確認 | ダッシュボードのページタイトルに「ダッシュボード」が含まれること |

---

### シナリオ 2: ログイン - 異常系

**テストラベル:** `ログイン - 異常系`

**概要:** 誤ったパスワードでログインを試みた際に、エラーメッセージが表示されることを確認する。

| エコー | 操作 / アサーション |
|---|---|
| `#` **認証機能** | — |
| `##` **ログイン失敗 - 誤パスワード** | — |
| `###` 誤った認証情報を入力 | `[data-testid="email-input"]` に `admin@demo.com` を入力 |
| | `[data-testid="password-input"]` に `wrongpassword` を入力 |
| `###` エラーメッセージの確認 | `[data-testid="login-button"]` をクリック |
| | `[data-testid="error-message"]` が表示されること |
| | エラーメッセージに「メールアドレスまたはパスワードが正しくありません」が含まれること |
| | URL が `/login` のままであること |

---

### シナリオ 3: ダッシュボード - 統計表示

**テストラベル:** `ダッシュボード - 統計表示`

**概要:** ログイン後のダッシュボードに顧客数の統計カードが正しく表示されることを確認する。

| エコー | 操作 / アサーション |
|---|---|
| `#` **ダッシュボード機能** | — |
| `##` **統計カードの表示確認** | — |
| ▶ フロー: **ログイン**（管理者アカウント） | — |
| `###` 各統計カードの存在確認 | `[data-testid="total-customers-card"]` が表示されていること |
| | `[data-testid="active-customers-card"]` が表示されていること |
| | `[data-testid="prospects-card"]` が表示されていること |
| | `[data-testid="new-this-month-card"]` が表示されていること |
| `###` 統計値の妥当性確認 | 「総顧客数」カードに数値が含まれること |
| | 「アクティブ」カードに数値が含まれること |

---

### シナリオ 4: 顧客一覧 - 検索・フィルター

**テストラベル:** `顧客一覧 - 検索・フィルター`

**概要:** 顧客一覧画面でのキーワード検索およびステータスフィルターが正常に動作することを確認する。

| エコー | 操作 / アサーション |
|---|---|
| `#` **顧客管理機能** | — |
| `##` **顧客一覧の表示** | — |
| ▶ フロー: **ログイン**（管理者アカウント） | — |
| `###` 顧客一覧ページへ遷移 | サイドバーの「顧客管理」をクリック |
| | URL が `/customers` であること |
| | `[data-testid="customers-table"]` が表示されていること |
| `##` **顧客名での検索** | — |
| `###` キーワード検索の実行 | `[data-testid="search-input"]` に `田中` を入力 |
| | `[data-testid="search-button"]` をクリック |
| | テーブルに「田中」を含む行が表示されること |
| | テーブルに「田中」を含まない行が表示されないこと |
| `###` 検索リセット | `[data-testid="search-input"]` をクリアして空にする |
| | `[data-testid="search-button"]` をクリック |
| `##` **ステータスフィルター** | — |
| `###` ACTIVE フィルターの適用 | `[data-testid="status-filter"]` で `ACTIVE` を選択 |
| | `[data-testid="search-button"]` をクリック |
| | テーブルの全行にステータス「取引中」が含まれること |

---

### シナリオ 5: 顧客 - 新規登録

**テストラベル:** `顧客 - 新規登録`

**概要:** 新規顧客登録フォームに必要情報を入力して登録し、一覧に反映されることを確認する。

| エコー | 操作 / アサーション |
|---|---|
| `#` **顧客管理機能** | — |
| `##` **新規顧客の登録** | — |
| ▶ フロー: **ログイン**（管理者アカウント） | — |
| `###` 新規登録フォームへ遷移 | 顧客一覧ページの「新規登録」ボタンをクリック |
| | URL が `/customers/new` であること |
| `###` フォームへの入力 | `[data-testid="name-input"]` に `テスト 太郎` を入力 |
| | `[data-testid="email-input"]` に `test.taro@example.co.jp` を入力 |
| | `[data-testid="phone-input"]` に `03-0000-0000` を入力 |
| | `[data-testid="company-input"]` に `テスト株式会社` を入力 |
| | `[data-testid="status-select"]` で `PROSPECT` を選択 |
| `###` 登録実行と結果確認 | `[data-testid="save-button"]` をクリック |
| | URL が `/customers` にリダイレクトされること |
| | テーブルに「テスト 太郎」が含まれること |

---

### シナリオ 6: 顧客 - 情報編集

**テストラベル:** `顧客 - 情報編集`

**概要:** 既存顧客のステータスおよびメモを編集して保存できることを確認する。

| エコー | 操作 / アサーション |
|---|---|
| `#` **顧客管理機能** | — |
| `##` **顧客情報の編集** | — |
| ▶ フロー: **ログイン**（管理者アカウント） | — |
| `###` 対象顧客の編集ページへ遷移 | 顧客一覧から「テスト 太郎」の `[data-testid^="edit-button-"]` をクリック |
| | URL が `/customers/[id]` の形式であること |
| | `[data-testid="name-input"]` に「テスト 太郎」が入力済みであること |
| `###` 情報の更新 | `[data-testid="status-select"]` で `ACTIVE` を選択 |
| | `[data-testid="notes-input"]` に `mabl テストで登録した顧客` を入力 |
| `###` 保存と結果確認 | `[data-testid="save-button"]` をクリック |
| | ステータスが「取引中」に変わっていること |

---

### シナリオ 7: 顧客 - 削除

**テストラベル:** `顧客 - 削除`

**概要:** 顧客を削除した後、一覧から該当顧客が消えることを確認する。

> **注:** `window.confirm` の代わりにカスタム確認モーダルを実装済み。

| エコー | 操作 / アサーション |
|---|---|
| `#` **顧客管理機能** | — |
| `##` **顧客の削除** | — |
| ▶ フロー: **ログイン**（管理者アカウント） | — |
| `###` 削除対象の確認 | 顧客一覧で「テスト 太郎」の行が存在すること |
| `###` 削除の実行 | 「テスト 太郎」の `[data-testid^="delete-button-"]` をクリック |
| | `[data-testid="delete-confirm-dialog"]` が表示されること |
| | `[data-testid="delete-confirm-message"]` に「テスト 太郎」が含まれること |
| | `[data-testid="delete-confirm-ok"]` をクリック |
| `###` 削除結果の確認 | `[data-testid="delete-confirm-dialog"]` が消えること |
| | テーブルに「テスト 太郎」が含まれないこと |

---

### シナリオ 8: ログアウト - 認証保護

**テストラベル:** `ログアウト - 認証保護`

**概要:** ログアウト後にダッシュボードへのアクセスがログイン画面にリダイレクトされることを確認する。

| エコー | 操作 / アサーション |
|---|---|
| `#` **認証機能** | — |
| `##` **ログアウト** | — |
| ▶ フロー: **ログイン**（管理者アカウント） | — |
| `###` ログアウトの実行 | `[data-testid="logout-button"]` をクリック |
| `###` ログアウト結果の確認 | URL が `/login` にリダイレクトされること |
| | `[data-testid="login-button"]` が表示されていること |
| `###` 認証保護の確認 | `/customers` に直接アクセス |
| | `/login` にリダイレクトされること |

---

## data-testid 一覧

| data-testid | 画面 | 要素 |
|---|---|---|
| `email-input` | ログイン | メールアドレス入力欄 |
| `password-input` | ログイン | パスワード入力欄 |
| `login-button` | ログイン | ログインボタン |
| `error-message` | ログイン | エラーメッセージ |
| `logout-button` | 共通ヘッダー | ログアウトボタン |
| `total-customers-card` | ダッシュボード | 総顧客数カード |
| `active-customers-card` | ダッシュボード | アクティブカード |
| `prospects-card` | ダッシュボード | 見込みカード |
| `new-this-month-card` | ダッシュボード | 今月の新規カード |
| `search-input` | 顧客一覧 | 検索入力欄 |
| `status-filter` | 顧客一覧 | ステータスフィルター |
| `search-button` | 顧客一覧 | 検索ボタン |
| `new-customer-button` | 顧客一覧 | 新規登録ボタン |
| `customers-table` | 顧客一覧 | 顧客テーブル |
| `customer-row-{id}` | 顧客一覧 | 顧客行（ID別） |
| `edit-button-{id}` | 顧客一覧 | 編集ボタン（ID別） |
| `delete-button-{id}` | 顧客一覧 | 削除ボタン（ID別） |
| `delete-confirm-dialog` | 顧客一覧 | 削除確認モーダル |
| `delete-confirm-message` | 顧客一覧 | 削除確認メッセージ |
| `delete-confirm-cancel` | 顧客一覧 | 削除キャンセルボタン |
| `delete-confirm-ok` | 顧客一覧 | 削除実行ボタン |
| `name-input` | 顧客詳細・新規 | 顧客名入力欄 |
| `email-input` | 顧客詳細・新規 | メールアドレス入力欄 |
| `phone-input` | 顧客詳細・新規 | 電話番号入力欄 |
| `company-input` | 顧客詳細・新規 | 会社名入力欄 |
| `status-select` | 顧客詳細・新規 | ステータス選択 |
| `notes-input` | 顧客詳細・新規 | メモ入力欄 |
| `save-button` | 顧客詳細・新規 | 保存ボタン |
| `cancel-button` | 顧客詳細 | キャンセルボタン |
| `edit-button` | 顧客詳細 | 編集ボタン |
| `back-button` | 顧客詳細 | 戻るボタン |
